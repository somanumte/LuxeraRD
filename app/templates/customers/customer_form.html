{% extends 'base.html' %}

{% block title %}{{ 'Editar' if mode == 'edit' else 'Agregar' }} Cliente{% endblock %}

{% block extra_css %}
<style>
    .hidden-field {
        display: none;
    }
    .error-message {
        color: #ef4444;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
    /* Estilo para campos no editables manualmente */
    .readonly-field {
        background-color: #f3f4f6 !important;
        cursor: not-allowed;
    }
    .dark .readonly-field {
        background-color: #1f2937 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">

        <div class="mb-8">
            <div class="flex items-center space-x-3 mb-4">
                <a href="{{ url_for('customers.customers_list') }}" class="text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                </a>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
                    {% if mode == 'edit' %}
                        Editar Cliente
                    {% else %}
                        Agregar Nuevo Cliente
                    {% endif %}
                </h1>
            </div>
        </div>

        <form method="POST" id="customer-form" class="space-y-6">
            {{ form.hidden_tag() }}

            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 border border-gray-200 dark:border-gray-700">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2"></path>
                    </svg>
                    Identificación del Cliente
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                            {{ form.id_number.label.text }} <span class="text-red-500">*</span>
                        </label>
                        {{ form.id_number(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20", placeholder="Ingrese solo números", maxlength="13") }}
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400" id="id-helper-text">
                            Formato automático: 11 dígitos (Cédula) o 9 dígitos (RNC)
                        </p>
                        <div id="id-error-message" class="error-message hidden"></div>
                        {% if form.id_number.errors %}
                            <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.id_number.errors[0] }}</p>
                        {% endif %}
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                            {{ form.id_type.label.text }}
                        </label>
                        {{ form.id_type(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 readonly-field", readonly=True, tabindex="-1") }}
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                            {{ form.customer_type.label.text }}
                        </label>
                        {{ form.customer_type(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 readonly-field", readonly=True, tabindex="-1") }}
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 border border-gray-200 dark:border-gray-700">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2"></path>
                    </svg>
                    <span id="info-header">Información Personal</span>
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div id="person-fields">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                {{ form.first_name.label.text }} <span class="text-red-500">*</span>
                            </label>
                            {{ form.first_name(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20") }}
                            {% if form.first_name.errors %}
                                <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.first_name.errors[0] }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <div id="person-fields-2">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                {{ form.last_name.label.text }} <span class="text-red-500">*</span>
                            </label>
                            {{ form.last_name(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20") }}
                            {% if form.last_name.errors %}
                                <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.last_name.errors[0] }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <div id="company-fields" class="hidden-field md:col-span-2">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                {{ form.company_name.label.text }} <span class="text-red-500">*</span>
                            </label>
                            {{ form.company_name(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20") }}
                            {% if form.company_name.errors %}
                                <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.company_name.errors[0] }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 border border-gray-200 dark:border-gray-700">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                    </svg>
                    Información de Contacto
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                            {{ form.email.label.text }} <span class="text-red-500">*</span>
                        </label>
                        {{ form.email(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20") }}
                        <div id="email-error-message" class="error-message hidden"></div>
                        {% if form.email.errors %}
                            <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.email.errors[0] }}</p>
                        {% endif %}
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                            {{ form.phone_primary.label.text }} <span class="text-red-500">*</span>
                        </label>
                        {{ form.phone_primary(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20") }}
                        <div id="phone-error-message" class="error-message hidden"></div>
                        {% if form.phone_primary.errors %}
                            <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.phone_primary.errors[0] }}</p>
                        {% endif %}
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                            {{ form.phone_secondary.label.text }}
                        </label>
                        {{ form.phone_secondary(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20") }}
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                            {{ form.whatsapp.label.text }}
                        </label>
                        {{ form.whatsapp(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20") }}
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 border border-gray-200 dark:border-gray-700">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    Dirección
                </h2>

                <div class="grid grid-cols-1 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                            {{ form.address_line1.label.text }}
                        </label>
                        {{ form.address_line1(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20") }}
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                            {{ form.address_line2.label.text }}
                        </label>
                        {{ form.address_line2(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20") }}
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                {{ form.city.label.text }}
                            </label>
                            {{ form.city(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20") }}
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                {{ form.province.label.text }}
                            </label>
                            {{ form.province(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20") }}
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                {{ form.postal_code.label.text }}
                            </label>
                            {{ form.postal_code(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20") }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 border border-gray-200 dark:border-gray-700">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
                    </svg>
                    Información Adicional
                </h2>

                <div class="grid grid-cols-1 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                            {{ form.credit_limit.label.text }}
                        </label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">$</span>
                            {{ form.credit_limit(class="w-full pl-8 pr-4 py-3 border-2 border-gray-200 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20") }}
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                            {{ form.notes.label.text }}
                        </label>
                        {{ form.notes(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20") }}
                    </div>

                    <div>
                        <label class="inline-flex items-center">
                            {{ form.is_active(class="h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded") }}
                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300 font-semibold">{{ form.is_active.label.text }}</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="flex items-center justify-between">
                <a href="{{ url_for('customers.customers_list') }}" class="px-6 py-3 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors font-semibold">
                    Cancelar
                </a>

                <button type="submit" class="px-8 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300">
                    {{ form.submit.label.text }}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const customerTypeSelect = document.getElementById('customer_type');
    const idTypeSelect = document.getElementById('id_type');
    const idNumberInput = document.getElementById('id_number');
    const personFields = document.getElementById('person-fields');
    const personFields2 = document.getElementById('person-fields-2');
    const companyFields = document.getElementById('company-fields');
    const infoHeader = document.getElementById('info-header');
    const idHelperText = document.getElementById('id-helper-text');
    const idErrorMessage = document.getElementById('id-error-message');
    const emailInput = document.getElementById('email');
    const emailErrorMessage = document.getElementById('email-error-message');
    const phonePrimaryInput = document.getElementById('phone_primary');
    const phoneSecondaryInput = document.getElementById('phone_secondary');
    const phoneErrorMessage = document.getElementById('phone-error-message');
    const customerForm = document.getElementById('customer-form');

    function formatIdNumber(value) {
        const digits = value.replace(/\D/g, '');
        if (digits.length === 11) {
            return digits.replace(/(\d{3})(\d{7})(\d{1})/, '$1-$2-$3');
        } else if (digits.length === 9) {
            return digits.replace(/(\d{3})(\d{5})(\d{1})/, '$1-$2-$3');
        }
        return digits;
    }

    function autoDetectIdType(value) {
        const digits = value.replace(/\D/g, '');
        if (digits.length === 11) {
            customerTypeSelect.value = 'person';
            idTypeSelect.value = 'cedula';
            return 'cedula';
        } else if (digits.length === 9) {
            customerTypeSelect.value = 'company';
            idTypeSelect.value = 'rnc';
            return 'rnc';
        } else if (digits.length > 0 && digits.length !== 11 && digits.length !== 9) {
           idErrorMessage.classList.remove('hidden');
            return null;
        } else {
            idErrorMessage.classList.add('hidden');
            return null;
        }
    }

    function updateFormFields() {
        const customerType = customerTypeSelect.value;
        const idType = idTypeSelect.value;

        if (customerType === 'person') {
            personFields.classList.remove('hidden-field');
            personFields2.classList.remove('hidden-field');
            companyFields.classList.add('hidden-field');
            infoHeader.textContent = 'Información Personal';
        } else if (customerType === 'company') {
            personFields.classList.add('hidden-field');
            personFields2.classList.add('hidden-field');
            companyFields.classList.remove('hidden-field');
            infoHeader.textContent = 'Información de la Empresa';
        }
    }

    function validateEmail() {
        const email = emailInput.value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!email) {
            emailErrorMessage.textContent = 'El correo electrónico es requerido.';
            emailErrorMessage.classList.remove('hidden');
            return false;
        } else if (!emailRegex.test(email)) {
            emailErrorMessage.textContent = 'Por favor ingrese un correo electrónico válido.';
            emailErrorMessage.classList.remove('hidden');
            return false;
        } else {
            emailErrorMessage.classList.add('hidden');
            return true;
        }
    }

    function validatePhone() {
        const phonePrimary = phonePrimaryInput.value.trim();
        if (!phonePrimary) {
            phoneErrorMessage.textContent = 'El teléfono principal es requerido.';
            phoneErrorMessage.classList.remove('hidden');
            return false;
        } else {
            phoneErrorMessage.classList.add('hidden');
            return true;
        }
    }

    function validateForm() {
        const isEmailValid = validateEmail();
        const isPhoneValid = validatePhone();
        const idValue = idNumberInput.value.trim();
        const digits = idValue.replace(/\D/g, '');
        let isIdValid = true;

        if (digits.length === 0) {
            idErrorMessage.textContent = 'El número de identificación es requerido.';
            idErrorMessage.classList.remove('hidden');
            isIdValid = false;
        } else if (digits.length !== 11 && digits.length !== 9) {
            idErrorMessage.textContent = 'Debe tener 9 (RNC) u 11 (Cédula) dígitos.';
            idErrorMessage.classList.remove('hidden');
            isIdValid = false;
        }

        return isEmailValid && isPhoneValid && isIdValid;
    }

    idNumberInput.addEventListener('input', function(e) {
        const cursorPosition = e.target.selectionStart;
        const formattedValue = formatIdNumber(e.target.value);
        e.target.value = formattedValue;

        const change = formattedValue.length - e.target.value.length;
        e.target.setSelectionRange(cursorPosition + change, cursorPosition + change);

        const detectedType = autoDetectIdType(formattedValue);
        updateFormFields();
    });

    idNumberInput.addEventListener('blur', function() {
        const digits = this.value.replace(/\D/g, '');
        if (digits.length === 11 || digits.length === 9) {
            this.value = formatIdNumber(this.value);
            autoDetectIdType(this.value);
            updateFormFields();
        }
    });

    emailInput.addEventListener('blur', validateEmail);
    phonePrimaryInput.addEventListener('blur', validatePhone);

    customerForm.addEventListener('submit', function(e) {
        if (!validateForm()) {
            e.preventDefault();
            const firstError = document.querySelector('.error-message:not(.hidden)');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    });

    // Inicialización
    if (idNumberInput.value) {
        idNumberInput.value = formatIdNumber(idNumberInput.value);
        autoDetectIdType(idNumberInput.value);
    }
    updateFormFields();
});
</script>
{% endblock %}