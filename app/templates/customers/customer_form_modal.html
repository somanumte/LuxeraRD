<!-- Formulario de cliente estilo Zoho - Versión Compacta -->
<form method="POST" id="customer-form" class="space-y-4">
    {{ form.hidden_tag() }}

    <!-- Sección 1: Identificación (2 columnas compactas) -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4 border border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
            <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2"></path>
            </svg>
            Identificación
        </h3>

        <div class="grid grid-cols-1 gap-3">
            <!-- Número de Identificación -->
            <div>
                <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                    {{ form.id_number.label.text }} <span class="text-red-500">*</span>
                </label>
                {{ form.id_number(class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/10", placeholder="Ej: 001-1234567-8", maxlength="13") }}
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                    9 dígitos (RNC) o 11 dígitos (Cédula)
                </p>
                <div id="id-error-message" class="error-message hidden text-xs"></div>
            </div>

            <!-- Tipo de Identificación y Tipo de cliente en la misma línea -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                    <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                        {{ form.id_type.label.text }}
                    </label>
                    {{ form.id_type(class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-800 text-gray-600 dark:text-gray-400 readonly-field", readonly=True, tabindex="-1") }}
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                        {{ form.customer_type.label.text }}
                    </label>
                    {{ form.customer_type(class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-800 text-gray-600 dark:text-gray-400 readonly-field", readonly=True, tabindex="-1") }}
                </div>
            </div>
        </div>
    </div>

    <!-- Sección 2: Información Personal/Empresa (combinada) -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4 border border-gray-200 dark:border-gray-700">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <!-- Campos de Persona -->
            <div id="person-fields" class="space-y-3">
                <div>
                    <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                        {{ form.first_name.label.text }} <span class="text-red-500">*</span>
                    </label>
                    {{ form.first_name(class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/10") }}
                </div>
            </div>

            <div id="person-fields-2" class="space-y-3">
                <div>
                    <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                        {{ form.last_name.label.text }} <span class="text-red-500">*</span>
                    </label>
                    {{ form.last_name(class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/10") }}
                </div>
            </div>

            <!-- Campos de Empresa -->
            <div id="company-fields" class="hidden-field md:col-span-2">
                <div>
                    <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                        {{ form.company_name.label.text }} <span class="text-red-500">*</span>
                    </label>
                    {{ form.company_name(class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/10") }}
                </div>
            </div>
        </div>
    </div>

    <!-- Sección 3: Contacto y Dirección (combinada en 2 columnas) -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Contacto -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4 border border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
                <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                </svg>
                Contacto
            </h3>

            <div class="space-y-3">
                <div>
                    <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                        {{ form.email.label.text }} <span class="text-red-500">*</span>
                    </label>
                    {{ form.email(class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/10") }}
                    <div id="email-error-message" class="error-message hidden text-xs mt-1"></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                            {{ form.phone_primary.label.text }} <span class="text-red-500">*</span>
                        </label>
                        {{ form.phone_primary(class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/10") }}
                        <div id="phone-error-message" class="error-message hidden text-xs mt-1"></div>
                    </div>

                    <div>
                        <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                            {{ form.whatsapp.label.text }}
                        </label>
                        {{ form.whatsapp(class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/10") }}
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                        {{ form.phone_secondary.label.text }}
                    </label>
                    {{ form.phone_secondary(class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/10") }}
                </div>
            </div>
        </div>

        <!-- Dirección -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4 border border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
                <svg class="w-5 h-5 mr-2 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                Dirección
            </h3>

            <div class="space-y-3">
                <div>
                    <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                        {{ form.address_line1.label.text }}
                    </label>
                    {{ form.address_line1(class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/10") }}
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                        {{ form.address_line2.label.text }}
                    </label>
                    {{ form.address_line2(class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/10") }}
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                            {{ form.city.label.text }}
                        </label>
                        {{ form.city(class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/10") }}
                    </div>

                    <div>
                        <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                            {{ form.province.label.text }}
                        </label>
                        {{ form.province(class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/10") }}
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                        {{ form.postal_code.label.text }}
                    </label>
                    {{ form.postal_code(class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/10") }}
                </div>
            </div>
        </div>
    </div>

    <!-- Sección 4: Información Adicional Compacta (Colapsable) -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
        <!-- Cabecera colapsable -->
        <button type="button"
                id="additional-info-toggle"
                class="w-full px-4 py-3 flex items-center justify-between text-left hover:bg-gray-50 dark:hover:bg-gray-750 transition-colors">
            <div class="flex items-center">
                <svg class="w-5 h-5 mr-2 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
                </svg>
                <span class="text-lg font-semibold text-gray-900 dark:text-white">Información Adicional</span>
            </div>
            <svg id="additional-info-chevron" class="w-5 h-5 text-gray-400 transform transition-transform duration-200 rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </button>

        <!-- Contenido colapsable -->
        <div id="additional-info-content" class="px-4 pb-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 pt-2">
                <div>
                    <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                        {{ form.credit_limit.label.text }}
                    </label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500 text-sm">$</span>
                        {{ form.credit_limit(class="w-full pl-8 pr-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/10") }}
                    </div>
                </div>

                <div class="md:col-span-2">
                    <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                        {{ form.notes.label.text }}
                    </label>
                    {{ form.notes(class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/10", rows="2") }}
                </div>

                <div class="flex items-center">
                    <label class="inline-flex items-center">
                        {{ form.is_active(class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded") }}
                        <span class="ml-2 text-xs font-semibold text-gray-700 dark:text-gray-300">{{ form.is_active.label.text }}</span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Botones -->
    <div class="flex items-center justify-between pt-3">
        <a href="{{ url_for('customers.customers_list') }}" class="px-4 py-2 text-sm bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors font-medium">
            Cancelar
        </a>

        <button type="submit" class="px-6 py-2 text-sm bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-medium rounded shadow hover:shadow-md transform hover:-translate-y-0.5 transition-all duration-200">
            {{ form.submit.label.text }}
        </button>
    </div>
</form>

<style>
    .hidden-field {
        display: none;
    }
    .readonly-field {
        background-color: #f9fafb !important;
        cursor: not-allowed;
        color: #6b7280;
    }
    .dark .readonly-field {
        background-color: #111827 !important;
        color: #9ca3af;
    }

    .error-message {
        color: #dc2626;
    }
    .dark .error-message {
        color: #f87171;
    }

    /* Para pantallas grandes, limitamos el ancho */
    @media (min-width: 1280px) {
        #customer-form {
            max-width: 900px;
            margin: 0 auto;
        }
    }

    /* Clases para el estado expandido/colapsado */
    .rotate-180 {
        transform: rotate(180deg);
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const customerTypeSelect = document.getElementById('customer_type');
    const idTypeSelect = document.getElementById('id_type');
    const idNumberInput = document.getElementById('id_number');
    const personFields = document.getElementById('person-fields');
    const personFields2 = document.getElementById('person-fields-2');
    const companyFields = document.getElementById('company-fields');
    const emailInput = document.getElementById('email');
    const emailErrorMessage = document.getElementById('email-error-message');
    const phonePrimaryInput = document.getElementById('phone_primary');
    const phoneErrorMessage = document.getElementById('phone-error-message');
    const customerForm = document.getElementById('customer-form');

    // Elementos para la sección colapsable
    const additionalInfoToggle = document.getElementById('additional-info-toggle');
    const additionalInfoContent = document.getElementById('additional-info-content');
    const additionalInfoChevron = document.getElementById('additional-info-chevron');

    // Función para formatear ID (mantenida igual)
    function formatIdNumber(value) {
        const digits = value.replace(/\D/g, '');
        if (digits.length === 11) {
            return digits.replace(/(\d{3})(\d{7})(\d{1})/, '$1-$2-$3');
        } else if (digits.length === 9) {
            return digits.replace(/(\d{3})(\d{5})(\d{1})/, '$1-$2-$3');
        }
        return digits;
    }

    // Función para detectar tipo de ID (mantenida igual)
    function autoDetectIdType(value) {
        const digits = value.replace(/\D/g, '');
        if (digits.length === 11) {
            customerTypeSelect.value = 'person';
            idTypeSelect.value = 'cedula';
            return 'cedula';
        } else if (digits.length === 9) {
            customerTypeSelect.value = 'company';
            idTypeSelect.value = 'rnc';
            return 'rnc';
        } else if (digits.length > 0 && digits.length !== 11 && digits.length !== 9) {
            showIdError('Debe tener 9 (RNC) u 11 (Cédula) dígitos.');
            return null;
        } else {
            hideIdError();
            return null;
        }
    }

    function showIdError(message) {
        const errorDiv = document.getElementById('id-error-message');
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
        idNumberInput.classList.add('border-red-500');
    }

    function hideIdError() {
        const errorDiv = document.getElementById('id-error-message');
        errorDiv.classList.add('hidden');
        idNumberInput.classList.remove('border-red-500');
    }

    // Función para actualizar campos (modificada para versión compacta)
    function updateFormFields() {
        const customerType = customerTypeSelect.value;

        if (customerType === 'person') {
            personFields.classList.remove('hidden-field');
            personFields2.classList.remove('hidden-field');
            companyFields.classList.add('hidden-field');
        } else if (customerType === 'company') {
            personFields.classList.add('hidden-field');
            personFields2.classList.add('hidden-field');
            companyFields.classList.remove('hidden-field');
        }
    }

    // Funciones de validación (mantenidas igual)
    function validateEmail() {
        const email = emailInput.value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!email) {
            emailErrorMessage.textContent = 'El correo electrónico es requerido.';
            emailErrorMessage.classList.remove('hidden');
            emailInput.classList.add('border-red-500');
            return false;
        } else if (!emailRegex.test(email)) {
            emailErrorMessage.textContent = 'Por favor ingrese un correo electrónico válido.';
            emailErrorMessage.classList.remove('hidden');
            emailInput.classList.add('border-red-500');
            return false;
        } else {
            emailErrorMessage.classList.add('hidden');
            emailInput.classList.remove('border-red-500');
            return true;
        }
    }

    function validatePhone() {
        const phonePrimary = phonePrimaryInput.value.trim();
        if (!phonePrimary) {
            phoneErrorMessage.textContent = 'El teléfono principal es requerido.';
            phoneErrorMessage.classList.remove('hidden');
            phonePrimaryInput.classList.add('border-red-500');
            return false;
        } else {
            phoneErrorMessage.classList.add('hidden');
            phonePrimaryInput.classList.remove('border-red-500');
            return true;
        }
    }

    function validateForm() {
        const isEmailValid = validateEmail();
        const isPhoneValid = validatePhone();
        const idValue = idNumberInput.value.trim();
        const digits = idValue.replace(/\D/g, '');
        let isIdValid = true;

        if (digits.length === 0) {
            showIdError('El número de identificación es requerido.');
            isIdValid = false;
        } else if (digits.length !== 11 && digits.length !== 9) {
            showIdError('Debe tener 9 (RNC) u 11 (Cédula) dígitos.');
            isIdValid = false;
        } else {
            hideIdError();
        }

        return isEmailValid && isPhoneValid && isIdValid;
    }

    // Función para alternar la sección de información adicional - CORREGIDA
    function toggleAdditionalInfo(e) {
        e.preventDefault();
        e.stopPropagation();

        const isHidden = additionalInfoContent.classList.contains('hidden');

        if (isHidden) {
            // Expandir
            additionalInfoContent.classList.remove('hidden');
            additionalInfoChevron.classList.add('rotate-180');
        } else {
            // Colapsar
            additionalInfoContent.classList.add('hidden');
            additionalInfoChevron.classList.remove('rotate-180');
        }
    }

    // Event listeners (mantenidos igual)
    idNumberInput.addEventListener('input', function(e) {
        const cursorPosition = e.target.selectionStart;
        const formattedValue = formatIdNumber(e.target.value);
        e.target.value = formattedValue;

        const change = formattedValue.length - e.target.value.length;
        e.target.setSelectionRange(cursorPosition + change, cursorPosition + change);

        autoDetectIdType(formattedValue);
        updateFormFields();
    });

    idNumberInput.addEventListener('blur', function() {
        const digits = this.value.replace(/\D/g, '');
        if (digits.length === 11 || digits.length === 9) {
            this.value = formatIdNumber(this.value);
            autoDetectIdType(this.value);
            updateFormFields();
        }
    });

    emailInput.addEventListener('blur', validateEmail);
    phonePrimaryInput.addEventListener('blur', validatePhone);

    // Event listener para la sección colapsable - CORREGIDO
    additionalInfoToggle.addEventListener('click', toggleAdditionalInfo);

    customerForm.addEventListener('submit', function(e) {
        if (!validateForm()) {
            e.preventDefault();
            const firstError = document.querySelector('.error-message:not(.hidden)');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    });

    // Inicialización
    if (idNumberInput.value) {
        idNumberInput.value = formatIdNumber(idNumberInput.value);
        autoDetectIdType(idNumberInput.value);
    }
    updateFormFields();
});
</script>