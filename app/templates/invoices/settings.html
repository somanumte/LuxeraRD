{% extends "base.html" %}

{% block title %}Configuración de Facturación{% endblock %}

{% block content %}
<div class="p-6 space-y-8">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Configuración de Facturación</h1>
            <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">
                Configura la información de tu empresa y los parámetros de facturación
            </p>
        </div>
        <a href="{{ url_for('invoices.invoices_list') }}"
           class="inline-flex items-center justify-center px-4 py-2 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
            Volver
        </a>
    </div>

    <form method="POST" action="{{ url_for('invoices.settings_update') }}" class="space-y-8">
        <!-- Primera fila: Empresa + Logo -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Información de la Empresa -->
            <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 shadow-sm">
                <div class="flex items-center gap-2 mb-6">
                    <div class="p-2 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg">
                        <svg class="w-5 h-5 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                    </div>
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Información de la Empresa</h2>
                </div>

                <div class="space-y-5">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Nombre de la Empresa <span class="text-red-500">*</span>
                        </label>
                        <input type="text"
                               name="company_name"
                               value="{{ settings.company_name }}"
                               required
                               class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-700 dark:text-white transition-colors">
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                RNC de la Empresa
                            </label>
                            <input type="text"
                                   name="company_rnc"
                                   value="{{ settings.company_rnc or '' }}"
                                   placeholder="000-0000000-0"
                                   class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-700 dark:text-white transition-colors">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Teléfono
                            </label>
                            <input type="text"
                                   name="company_phone"
                                   value="{{ settings.company_phone or '' }}"
                                   placeholder="(809) 000-0000"
                                   class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-700 dark:text-white transition-colors">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Email
                        </label>
                        <input type="email"
                               name="company_email"
                               value="{{ settings.company_email or '' }}"
                               placeholder="contacto@empresa.com"
                               class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-700 dark:text-white transition-colors">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Dirección
                        </label>
                        <textarea name="company_address"
                                  rows="3"
                                  class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-700 dark:text-white transition-colors">{{ settings.company_address or '' }}</textarea>
                    </div>
                </div>
            </div>

            <!-- Logo de la Empresa -->
            <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 shadow-sm">
                <div class="flex items-center gap-2 mb-6">
                    <div class="p-2 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg">
                        <svg class="w-5 h-5 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Logo de la Empresa</h2>
                </div>

                <div class="space-y-5">
                    <!-- Vista previa del logo -->
                    <div id="logo-preview-container" class="flex items-center justify-center p-6 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl bg-gray-50 dark:bg-gray-900/50">
                        {% if settings.logo_path and settings.has_logo() %}
                        <div class="text-center">
                            <img src="{{ settings.get_logo_url() }}"
                                 alt="Logo {{ settings.company_name }}"
                                 id="logo-preview"
                                 class="max-h-40 mx-auto mb-4 object-contain">
                            <p class="text-xs text-gray-500">{{ settings.logo_path }}</p>
                        </div>
                        {% else %}
                        <div class="text-center py-6">
                            <div class="w-16 h-16 mx-auto mb-4 flex items-center justify-center rounded-full bg-gray-100 dark:bg-gray-700">
                                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">No hay logo configurado</p>
                            <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">PNG o JPG, máximo 2MB</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Acciones del logo -->
                    <div class="flex flex-col sm:flex-row gap-3">
                        <div class="flex-1">
                            <input type="file"
                                   id="logo-file-input"
                                   accept="image/png, image/jpeg, image/gif, image/svg+xml, image/webp"
                                   class="hidden">
                            <button type="button"
                                    onclick="document.getElementById('logo-file-input').click()"
                                    class="w-full px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium transition-colors flex items-center justify-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                                </svg>
                                Subir Logo
                            </button>
                        </div>

                        {% if settings.logo_path and settings.has_logo() %}
                        <button type="button"
                                onclick="removeLogo()"
                                class="px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium transition-colors flex items-center justify-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                            Eliminar
                        </button>
                        {% endif %}
                    </div>

                    <!-- Mensajes de estado -->
                    <div id="logo-message" class="text-sm hidden"></div>
                </div>
            </div>
        </div>

        <!-- Segunda fila: NCF + Numeración -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Configuración de NCF (ACTUALIZADO CON TODOS LOS TIPOS DGII) -->
            <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 shadow-sm">
                <div class="flex items-center gap-2 mb-6">
                    <div class="p-2 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg">
                        <svg class="w-5 h-5 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Configuración de NCF</h2>
                </div>

                <div class="space-y-5">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Prefijo NCF <span class="text-red-500">*</span>
                        </label>
                        <select name="ncf_prefix"
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-700 dark:text-white transition-colors">
                            <!-- COMPROBANTES PARA VENTAS -->
                            <optgroup label="Comprobantes para Ventas (Emisión)">
                                <option value="B01" {% if settings.ncf_prefix == 'B01' %}selected{% endif %}>B01 - Factura de Crédito Fiscal</option>
                                <option value="B02" {% if settings.ncf_prefix == 'B02' %}selected{% endif %}>B02 - Factura de Consumo</option>
                                <option value="B03" {% if settings.ncf_prefix == 'B03' %}selected{% endif %}>B03 - Nota de Débito</option>
                                <option value="B04" {% if settings.ncf_prefix == 'B04' %}selected{% endif %}>B04 - Nota de Crédito</option>
                                <option value="B14" {% if settings.ncf_prefix == 'B14' %}selected{% endif %}>B14 - Régimenes Especiales</option>
                                <option value="B15" {% if settings.ncf_prefix == 'B15' %}selected{% endif %}>B15 - Gubernamental</option>
                            </optgroup>

                            <!-- COMPROBANTES PARA GASTOS -->
                            <optgroup label="Comprobantes para Gastos (Recepción)">
                                <option value="B11" {% if settings.ncf_prefix == 'B11' %}selected{% endif %}>B11 - Comprobante de Compras</option>
                                <option value="B12" {% if settings.ncf_prefix == 'B12' %}selected{% endif %}>B12 - Gastos Menores</option>
                                <option value="B13" {% if settings.ncf_prefix == 'B13' %}selected{% endif %}>B13 - Pagos al Exterior</option>
                                <option value="B16" {% if settings.ncf_prefix == 'B16' %}selected{% endif %}>B16 - Exportaciones</option>
                            </optgroup>

                            <!-- COMPROBANTES REGÍMENES ESPECIALES (NO CONTRIBUYENTES) -->
                            <optgroup label="Regímenes Especiales (No Contribuyentes)">
                                <option value="E31" {% if settings.ncf_prefix == 'E31' %}selected{% endif %}>E31 - Crédito Fiscal (No Contrib.)</option>
                                <option value="E32" {% if settings.ncf_prefix == 'E32' %}selected{% endif %}>E32 - Consumo (No Contrib.)</option>
                                <option value="E33" {% if settings.ncf_prefix == 'E33' %}selected{% endif %}>E33 - Nota Débito (No Contrib.)</option>
                                <option value="E34" {% if settings.ncf_prefix == 'E34' %}selected{% endif %}>E34 - Nota Crédito (No Contrib.)</option>
                                <option value="E41" {% if settings.ncf_prefix == 'E41' %}selected{% endif %}>E41 - Régimen Esp. (No Contrib.)</option>
                                <option value="E42" {% if settings.ncf_prefix == 'E42' %}selected{% endif %}>E42 - Gubernamental (No Contrib.)</option>
                                <option value="E43" {% if settings.ncf_prefix == 'E43' %}selected{% endif %}>E43 - Exportaciones (No Contrib.)</option>
                                <option value="E44" {% if settings.ncf_prefix == 'E44' %}selected{% endif %}>E44 - Pagos Exterior (No Contrib.)</option>
                                <option value="E45" {% if settings.ncf_prefix == 'E45' %}selected{% endif %}>E45 - Compras (No Contrib.)</option>
                            </optgroup>
                        </select>
                        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                            Tipo de comprobante fiscal según DGII. Para ventas normales use B01 o B02.
                        </p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Próximo NCF
                        </label>
                        <div class="flex gap-2">
                            <input type="text"
                                   value="{{ settings.ncf_prefix }}"
                                   disabled
                                   class="w-24 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-mono text-center">
                            <input type="text"
                                   value="{{ '{:08d}'.format(settings.ncf_sequence) }}"
                                   disabled
                                   class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-mono">
                        </div>
                        <p class="mt-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                            Próximo: <span class="font-mono text-indigo-600 dark:text-indigo-400">{{ settings.ncf_prefix }}{{ '{:08d}'.format(settings.ncf_sequence) }}</span>
                        </p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            NCF Válido Hasta <span class="text-red-500">*</span>
                        </label>
                        <input type="date"
                               name="ncf_valid_until"
                               value="{% if settings.ncf_valid_until %}{{ settings.ncf_valid_until }}{% endif %}"
                               required
                               class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-700 dark:text-white transition-colors">
                        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                            Fecha de vencimiento de la secuencia de NCF (obligatorio según DGII)
                        </p>
                    </div>

                    <!-- Secuencia de NCF (manual) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Iniciar secuencia en
                        </label>
                        <div class="flex gap-2">
                            <input type="text"
                                   value="{{ settings.ncf_prefix }}"
                                   disabled
                                   class="w-24 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-mono text-center">
                            <input type="number"
                                   name="ncf_sequence"
                                   value="{{ settings.ncf_sequence }}"
                                   min="1"
                                   class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                        </div>
                        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                            Solo modifica si necesitas reiniciar la numeración (ej: nueva rango autorizado)
                        </p>
                    </div>
                </div>
            </div>

            <!-- Numeración de Facturas -->
            <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 shadow-sm">
                <div class="flex items-center gap-2 mb-6">
                    <div class="p-2 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg">
                        <svg class="w-5 h-5 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                    </div>
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Numeración de Facturas</h2>
                </div>

                <div class="space-y-5">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Prefijo de Factura
                        </label>
                        <input type="text"
                               name="invoice_prefix"
                               value="{{ settings.invoice_prefix }}"
                               maxlength="10"
                               class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-700 dark:text-white transition-colors">
                        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                            Ejemplo: INV, FACT, BOL, etc.
                        </p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Próximo Número
                        </label>
                        <div class="flex gap-2">
                            <input type="text"
                                   value="{{ settings.invoice_prefix }}-"
                                   disabled
                                   class="w-32 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-mono">
                            <input type="text"
                                   value="{{ '{:08d}'.format(settings.invoice_sequence) }}"
                                   disabled
                                   class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-mono">
                        </div>
                        <p class="mt-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                            Próxima: <span class="font-mono text-indigo-600 dark:text-indigo-400">{{ settings.invoice_prefix }}-{{ '{:08d}'.format(settings.invoice_sequence) }}</span>
                        </p>
                    </div>

                    <!-- Secuencia de Facturas (manual) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Iniciar numeración en
                        </label>
                        <div class="flex gap-2">
                            <input type="text"
                                   value="{{ settings.invoice_prefix }}-"
                                   disabled
                                   class="w-32 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-mono">
                            <input type="number"
                                   name="invoice_sequence"
                                   value="{{ settings.invoice_sequence }}"
                                   min="1"
                                   class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                        </div>
                        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                            Solo modifica si necesitas reiniciar la numeración
                        </p>
                    </div>

                    <!-- Formato de fecha para numeración -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Incluir año en numeración
                        </label>
                        <div class="flex items-center">
                            <input type="checkbox"
                                   name="include_year_in_number"
                                   id="include_year_in_number"
                                   class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                                   {% if settings.include_year_in_number %}checked{% endif %}>
                            <label for="include_year_in_number" class="ml-2 text-sm text-gray-700 dark:text-gray-300">
                                Ej: INV-2024-000001
                            </label>
                        </div>
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                            Recomendado para reiniciar numeración cada año
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tercera fila: Configuraciones adicionales -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Configuración de ITBIS -->
            <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 shadow-sm">
                <div class="flex items-center gap-2 mb-6">
                    <div class="p-2 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg">
                        <svg class="w-5 h-5 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 8h6m-5 0a3 3 0 110 6H9l3 3m-3-6h6m6 1a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Configuración de ITBIS</h2>
                </div>

                <div class="space-y-5">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Porcentaje de ITBIS (%)
                        </label>
                        <div class="flex items-center">
                            <input type="number"
                                   name="itbis_percentage"
                                   value="18"
                                   min="0"
                                   max="100"
                                   step="0.01"
                                   class="w-32 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                            <span class="ml-2 text-gray-700 dark:text-gray-300">%</span>
                        </div>
                        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                            Tasa de impuesto actual en República Dominicana: 18%
                        </p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Incluir ITBIS por defecto
                        </label>
                        <div class="flex items-center">
                            <input type="checkbox"
                                   name="include_itbis_by_default"
                                   id="include_itbis_by_default"
                                   class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                                   {% if settings.include_itbis_by_default %}checked{% endif %}>
                            <label for="include_itbis_by_default" class="ml-2 text-sm text-gray-700 dark:text-gray-300">
                                Aplicar ITBIS automáticamente en todas las facturas
                            </label>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Exentos de ITBIS
                        </label>
                        <textarea name="itbis_exempt_items"
                                  rows="3"
                                  placeholder="Ej: Libros, medicinas, alimentos básicos..."
                                  class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-700 dark:text-white transition-colors">{{ settings.itbis_exempt_items or '' }}</textarea>
                        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                            Lista de productos/servicios exentos de ITBIS (uno por línea)
                        </p>
                    </div>
                </div>
            </div>

            <!-- Configuración de Vencimientos -->
            <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 shadow-sm">
                <div class="flex items-center gap-2 mb-6">
                    <div class="p-2 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg">
                        <svg class="w-5 h-5 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Configuración de Vencimientos</h2>
                </div>

                <div class="space-y-5">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Días para vencimiento por defecto
                        </label>
                        <div class="flex items-center">
                            <input type="number"
                                   name="default_due_days"
                                   value="{{ settings.default_due_days or 30 }}"
                                   min="1"
                                   max="365"
                                   class="w-32 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                            <span class="ml-2 text-gray-700 dark:text-gray-300">días</span>
                        </div>
                        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                            Número de días después de la emisión para el vencimiento
                        </p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Recordar vencimientos
                        </label>
                        <div class="flex items-center">
                            <input type="number"
                                   name="reminder_days_before"
                                   value="{{ settings.reminder_days_before or 7 }}"
                                   min="1"
                                   max="30"
                                   class="w-32 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                            <span class="ml-2 text-gray-700 dark:text-gray-300">días antes del vencimiento</span>
                        </div>
                        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                            Enviar recordatorios esta cantidad de días antes del vencimiento
                        </p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Cargo por mora (% mensual)
                        </label>
                        <div class="flex items-center">
                            <input type="number"
                                   name="late_fee_percentage"
                                   value="{{ settings.late_fee_percentage or 2 }}"
                                   min="0"
                                   max="20"
                                   step="0.01"
                                   class="w-32 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                            <span class="ml-2 text-gray-700 dark:text-gray-300">% mensual</span>
                        </div>
                        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                            Porcentaje de interés por mora aplicado mensualmente
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Términos y Condiciones -->
        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 shadow-sm">
            <div class="flex items-center gap-2 mb-6">
                <div class="p-2 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg">
                    <svg class="w-5 h-5 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                </div>
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Términos y Condiciones por Defecto</h2>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                    Texto de Términos y Condiciones
                </label>
                <textarea name="default_terms"
                          rows="5"
                          placeholder="Ej: Esta factura deberá ser pagada en un plazo de 30 días. Cualquier retraso en el pago generará un interés del 2% mensual..."
                          class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-700 dark:text-white transition-colors">{{ settings.default_terms or '' }}</textarea>
                <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                    Estos términos aparecerán automáticamente en todas las nuevas facturas
                </p>
            </div>

            <div class="mt-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                    Notas por defecto
                </label>
                <textarea name="default_notes"
                          rows="3"
                          placeholder="Ej: Gracias por su compra. Para cualquier consulta contactar a..."
                          class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-700 dark:text-white transition-colors">{{ settings.default_notes or '' }}</textarea>
                <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                    Notas que aparecerán automáticamente en todas las nuevas facturas
                </p>
            </div>
        </div>

        <!-- Configuración de PDF -->
        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 shadow-sm">
            <div class="flex items-center gap-2 mb-6">
                <div class="p-2 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg">
                    <svg class="w-5 h-5 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                    </svg>
                </div>
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Configuración de PDF</h2>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Tamaño de papel
                    </label>
                    <select name="paper_size"
                            class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-700 dark:text-white transition-colors">
                        <option value="letter" {% if settings.paper_size == 'letter' %}selected{% endif %}>Carta (8.5" x 11")</option>
                        <option value="a4" {% if settings.paper_size == 'a4' %}selected{% endif %}>A4 (210mm x 297mm)</option>
                        <option value="legal" {% if settings.paper_size == 'legal' %}selected{% endif %}>Legal (8.5" x 14")</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Orientación
                    </label>
                    <select name="paper_orientation"
                            class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-700 dark:text-white transition-colors">
                        <option value="portrait" {% if settings.paper_orientation == 'portrait' %}selected{% endif %}>Vertical</option>
                        <option value="landscape" {% if settings.paper_orientation == 'landscape' %}selected{% endif %}>Horizontal</option>
                    </select>
                </div>

                <div class="md:col-span-2">
                    <div class="flex items-center">
                        <input type="checkbox"
                               name="show_business_info_in_footer"
                               id="show_business_info_in_footer"
                               class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                               {% if settings.show_business_info_in_footer %}checked{% endif %}>
                        <label for="show_business_info_in_footer" class="ml-2 text-sm text-gray-700 dark:text-gray-300">
                            Mostrar información de la empresa en pie de página
                        </label>
                    </div>
                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                        RNC, teléfono y email aparecerán en el pie de página del PDF
                    </p>
                </div>

                <div class="md:col-span-2">
                    <div class="flex items-center">
                        <input type="checkbox"
                               name="show_qr_code"
                               id="show_qr_code"
                               class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                               {% if settings.show_qr_code %}checked{% endif %}>
                        <label for="show_qr_code" class="ml-2 text-sm text-gray-700 dark:text-gray-300">
                            Incluir código QR en facturas
                        </label>
                    </div>
                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                        Genera un código QR con los datos de la factura para verificación rápida
                    </p>
                </div>
            </div>
        </div>

        <!-- Botones de Acción -->
        <div class="flex flex-col sm:flex-row gap-3 justify-end pt-6 border-t border-gray-200 dark:border-gray-700">
            <a href="{{ url_for('invoices.invoices_list') }}"
               class="px-6 py-3 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 font-semibold transition-colors text-center">
                Cancelar
            </a>
            <button type="submit"
                    class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold transition-colors flex items-center justify-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                Guardar Configuración
            </button>
        </div>
    </form>
</div>

<script>
// Manejar subida de logo
document.getElementById('logo-file-input').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    // Validar tamaño (2MB máximo)
    if (file.size > 2 * 1024 * 1024) {
        showLogoMessage('El archivo es muy grande. Máximo 2MB.', 'error');
        return;
    }

    // Mostrar preview
    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById('logo-preview-container').innerHTML = `
            <div class="text-center">
                <img src="${e.target.result}"
                     alt="Preview"
                     id="logo-preview"
                     class="max-h-40 mx-auto mb-4 object-contain animate-fade-in">
                <p class="text-xs text-gray-500">${file.name}</p>
            </div>
        `;
    };
    reader.readAsDataURL(file);

    // Subir al servidor
    uploadLogo(file);
});

function uploadLogo(file) {
    const formData = new FormData();
    formData.append('logo', file);

    showLogoMessage('Subiendo logo...', 'info');

    fetch('{{ url_for("invoices.upload_logo") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showLogoMessage(data.message, 'success');
            // Actualizar botón de eliminar
            document.querySelector('button[onclick="removeLogo()"]')?.remove();
            const actionsDiv = document.querySelector('.flex.gap-3');
            if (actionsDiv) {
                actionsDiv.innerHTML += `
                    <button type="button"
                            onclick="removeLogo()"
                            class="px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium transition-colors flex items-center justify-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        Eliminar
                    </button>
                `;
            }
        } else {
            showLogoMessage(data.message, 'error');
        }
    })
    .catch(error => {
        showLogoMessage('Error al subir el logo', 'error');
        console.error('Error:', error);
    });
}

function removeLogo() {
    if (!confirm('¿Estás seguro de eliminar el logo?')) return;

    showLogoMessage('Eliminando logo...', 'info');

    fetch('{{ url_for("invoices.remove_logo") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showLogoMessage(data.message, 'success');
            // Restaurar vista inicial
            document.getElementById('logo-preview-container').innerHTML = `
                <div class="text-center py-6">
                    <div class="w-16 h-16 mx-auto mb-4 flex items-center justify-center rounded-full bg-gray-100 dark:bg-gray-700">
                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">No hay logo configurado</p>
                    <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">PNG o JPG, máximo 2MB</p>
                </div>
            `;
            // Eliminar botón de eliminar
            document.querySelector('button[onclick="removeLogo()"]')?.remove();
        } else {
            showLogoMessage(data.message, 'error');
        }
    })
    .catch(error => {
        showLogoMessage('Error al eliminar el logo', 'error');
        console.error('Error:', error);
    });
}

function showLogoMessage(message, type) {
    const messageDiv = document.getElementById('logo-message');
    messageDiv.textContent = message;
    messageDiv.className = `text-sm ${type === 'success' ? 'text-green-600' : type === 'error' ? 'text-red-600' : 'text-blue-600'}`;
    messageDiv.classList.remove('hidden');

    setTimeout(() => {
        messageDiv.classList.add('hidden');
    }, 3000);
}

// Validar campos obligatorios
document.querySelector('form').addEventListener('submit', function(e) {
    const ncfValidUntil = document.querySelector('input[name="ncf_valid_until"]');
    if (!ncfValidUntil.value) {
        e.preventDefault();
        showLogoMessage('La fecha de vencimiento del NCF es obligatoria según DGII', 'error');
        ncfValidUntil.focus();
        return false;
    }
});
</script>
{% endblock %}