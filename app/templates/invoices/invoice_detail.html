{% extends "base.html" %}

{% block title %}Factura {{ invoice.invoice_number }}{% endblock %}

{% block extra_css %}
<style>
    /* Estilos generales */
    .invoice-border {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .watermark-bg {
        background-image: url("data:image/svg+xml,%3Csvg width='200' height='200' viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M20,20 L180,180 M180,20 L20,180' stroke='%23f3f4f6' stroke-width='0.5'/%3E%3C/svg%3E");
        background-size: 200px 200px;
        background-position: center;
    }

    .address-preserve {
        white-space: pre-line;
        line-height: 1.4;
    }

    .info-section {
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    @keyframes fade-in {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .animate-fade-in {
        animation: fade-in 0.3s ease-in-out;
    }

    .logo-frame {
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        padding: 3px;
        background-color: rgba(255, 255, 255, 0.1);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Estilos específicos para impresión PERFECTA en papel carta */
    @media print {
        /* Reset completo para impresión */
        * {
            -webkit-print-color-adjust: exact !important;
            color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        body {
            margin: 0 !important;
            padding: 0 !important;
            background: white !important;
            font-size: 10pt !important;
            line-height: 1.2 !important;
            width: 100% !important;
            height: 100% !important;
        }

        /* Ocultar TODO excepto la factura */
        body * {
            visibility: hidden !important;
        }

        #factura-impresion,
        #factura-impresion * {
            visibility: visible !important;
        }

        #factura-impresion {
            position: absolute !important;
            left: 0 !important;
            top: 0 !important;
            width: 100% !important;
            max-width: 100% !important;
            height: auto !important;
            margin: 0 !important;
            padding: 0 !important;
            border: none !important;
            box-shadow: none !important;
            background: white !important;
            page-break-inside: avoid !important;
            break-inside: avoid !important;
        }

        /* Ocultar elementos de la interfaz web */
        .no-print,
        .no-print *,
        button,
        .btn,
        nav,
        footer,
        .breadcrumb,
        .actions-header,
        .status-section,
        .delete-section,
        #encabezado-app,
        #boton-eliminar {
            display: none !important;
            visibility: hidden !important;
        }

        /* Configuración de página para papel carta (8.5" x 11") */
        @page {
            size: letter portrait !important;
            margin: 0.25in !important;
            padding: 0 !important;
        }

        /* Optimización de la factura para papel carta */
        .invoice-border {
            border: 2px solid #000000 !important;
            border-radius: 0 !important;
            margin: 0 auto !important;
            padding: 0 !important;
            width: 100% !important;
            max-width: 8in !important;
            min-height: 10in !important;
            overflow: hidden !important;
        }

        .watermark-bg {
            background-image: none !important;
        }

        /* Optimización de colores para impresión */
        .bg-gradient-to-r {
            background: linear-gradient(to right, #1e3a8a, #4c1d95) !important;
            color: white !important;
        }

        .bg-gray-50, .bg-gray-100 {
            background-color: #f9fafb !important;
        }

        .bg-indigo-50 {
            background-color: #eef2ff !important;
        }

        .bg-amber-50 {
            background-color: #fffbeb !important;
        }

        .bg-blue-50 {
            background-color: #eff6ff !important;
        }

        /* Textos optimizados para impresión */
        .text-white {
            color: white !important;
            -webkit-print-color-adjust: exact !important;
        }

        .text-gray-900, .text-gray-800, .text-gray-700 {
            color: #111827 !important;
        }

        .text-gray-600, .text-gray-500 {
            color: #4b5563 !important;
        }

        .text-indigo-100 {
            color: #e0e7ff !important;
        }

        /* Optimización de fuentes */
        body, .text-sm, .text-xs, .text-base, p, span, div, td, th {
            font-family: "Arial", "Helvetica", sans-serif !important;
            font-size: 9pt !important;
            line-height: 1.2 !important;
        }

        h1, h2, h3, .font-bold, .font-semibold, th {
            font-weight: 700 !important;
        }

        /* Tamaños específicos */
        .text-xs { font-size: 7pt !important; }
        .text-sm { font-size: 8pt !important; }
        .text-base { font-size: 9pt !important; }
        .text-lg { font-size: 10pt !important; }
        .text-xl { font-size: 11pt !important; }
        .text-2xl { font-size: 12pt !important; }

        /* Reducción de padding/margin para ahorrar espacio */
        .p-6 { padding: 0.2in !important; }
        .p-4 { padding: 0.15in !important; }
        .p-5 { padding: 0.175in !important; }
        .px-4 { padding-left: 0.15in !important; padding-right: 0.15in !important; }
        .py-3 { padding-top: 0.1in !important; padding-bottom: 0.1in !important; }
        .mb-6 { margin-bottom: 0.2in !important; }
        .mb-4 { margin-bottom: 0.15in !important; }
        .mb-3 { margin-bottom: 0.1in !important; }
        .mt-4 { margin-top: 0.15in !important; }
        .gap-6 { gap: 0.2in !important; }
        .gap-4 { gap: 0.15in !important; }
        .space-y-4 > * + * { margin-top: 0.15in !important; }
        .space-y-3 > * + * { margin-top: 0.1in !important; }

        /* Optimización de la tabla */
        table {
            width: 100% !important;
            table-layout: fixed !important;
            border-collapse: collapse !important;
        }

        th, td {
            padding: 4pt 6pt !important;
            border: 1px solid #d1d5db !important;
            vertical-align: top !important;
            page-break-inside: avoid !important;
            break-inside: avoid !important;
        }

        th {
            background-color: #f3f4f6 !important;
            font-weight: bold !important;
        }

        /* Columnas específicas para mejor uso del espacio */
        td:first-child { width: 10% !important; } /* Cantidad */
        td:nth-child(2) { width: 50% !important; } /* Descripción */
        td:nth-child(3) { width: 20% !important; } /* Precio */
        td:last-child { width: 20% !important; } /* Total */

        /* Evitar cortes de página en elementos importantes */
        .page-break-avoid {
            page-break-inside: avoid !important;
            break-inside: avoid !important;
        }

        /* Optimización del header */
        .bg-gradient-to-r.from-indigo-800.to-purple-800 {
            padding: 0.15in !important;
            min-height: 1in !important;
        }

        .logo-frame {
            border: 1px solid white !important;
            padding: 1px !important;
            max-height: 0.7in !important;
            max-width: 1in !important;
        }

        /* Optimización de la sección de totales */
        #total-display {
            font-size: 11pt !important;
            font-weight: 900 !important;
            color: #000000 !important;
        }

        /* Optimización de bordes */
        .border, .border-b, .border-t {
            border-color: #d1d5db !important;
        }

        /* Eliminar efectos hover y animaciones */
        .hover\:bg-gray-50:hover,
        .hover\:shadow-lg:hover,
        .transition-all,
        .duration-300,
        .animate-fade-in {
            all: unset !important;
            animation: none !important;
            transition: none !important;
        }

        /* Asegurar que los fondos se impriman */
        .bg-white {
            background-color: white !important;
        }

        /* Optimización del pie de página */
        .bg-gray-100 {
            padding: 0.15in !important;
            font-size: 7pt !important;
        }

        /* Ajuste de grid para impresión */
        .grid {
            display: grid !important;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)) !important;
            gap: 0.15in !important;
        }

        .grid-cols-3 {
            grid-template-columns: repeat(3, 1fr) !important;
        }

        /* Forzar que la factura quepa en una sola página */
        #factura-impresion {
            max-height: 10.5in !important;
            overflow: hidden !important;
        }
    }

    /* Botón de impresión */
    .print-button {
        display: inline-flex;
        align-items: center;
        padding: 10px 20px;
        background: linear-gradient(to right, #059669, #10b981);
        color: white;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.2s;
    }

    .print-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
</style>
{% endblock %}

{% block content %}
<!-- Área de la factura optimizada para IMPRESIÓN PERFECTA -->
<div id="factura-impresion" class="watermark-bg mx-auto bg-white text-gray-900 invoice-border page-break-avoid" style="max-width: 8in; margin: 0 auto;">
    <!-- Encabezado con logo -->
    <div class="bg-gradient-to-r from-indigo-800 to-purple-800 text-white p-6 page-break-avoid" style="padding: 0.15in;">
        <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 0.15in;">
            <!-- Información de la empresa -->
            <div style="flex: 1;">
                <div style="display: flex; align-items: flex-start; gap: 0.15in;">
                    <!-- Logo de la empresa (si existe) -->
                    {% if settings.logo_path and settings.has_logo() %}
                    <div style="flex-shrink: 0;">
                        <img src="{{ settings.get_logo_url() }}"
                             alt="Logo {{ settings.company_name }}"
                             style="height: 0.6in; width: auto; object-fit: contain; border: 1px solid white; padding: 1px; background-color: white;"
                             class="logo-frame">
                    </div>
                    {% endif %}

                    <div>
                        <h1 style="font-size: 12pt; font-weight: 900; color: white; margin-bottom: 0.05in;">
                            {{ settings.company_name }}
                        </h1>
                        <div style="font-size: 7pt; color: #e0e7ff; line-height: 1.2;">
                            {% if settings.company_rnc %}
                            <p style="margin: 0.03in 0;"><strong>RNC:</strong> {{ settings.company_rnc }}</p>
                            {% endif %}
                            {% if settings.company_address %}
                            <p style="margin: 0.03in 0; max-width: 2.5in; white-space: pre-line;" class="address-preserve">{{ settings.company_address }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Información de la factura -->
            <div style="margin-left: 0.15in; min-width: 1.5in;">
                <div style="font-size: 14pt; font-weight: 900; color: white; margin-bottom: 0.1in; text-align: right;">FACTURA</div>
                <div style="background-color: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); padding: 0.1in; border-radius: 3px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.03in; font-size: 7pt;">
                        <div style="color: #e0e7ff; font-weight: 600;">Número:</div>
                        <div style="color: white; font-weight: 700; text-align: right;">{{ invoice.invoice_number }}</div>

                        <div style="color: #e0e7ff; font-weight: 600;">Fecha:</div>
                        <div style="color: white; font-weight: 700; text-align: right;">{{ invoice.invoice_date.strftime('%d/%m/%Y') }}</div>

                        <div style="color: #e0e7ff; font-weight: 600;">NCF:</div>
                        <div style="color: white; font-weight: 700; font-family: monospace; text-align: right;">{{ invoice.ncf }}</div>

                            {% if settings.ncf_valid_until %}
                        <div style="color: #e0e7ff; font-weight: 600;">Válido Hasta:</div>
                        <div style="color: white; font-weight: 700; text-align: right;">
                            {% if settings.ncf_valid_until is string %}
                                {{ settings.ncf_valid_until }}
                            {% else %}
                                {{ settings.ncf_valid_until.strftime('%d/%m/%Y') }}
                            {% endif %}
                        </div>
                            {% endif %}

                        {% if invoice.due_date %}
                        <div style="color: #e0e7ff; font-weight: 600;">Vencimiento:</div>
                        <div style="color: white; font-weight: 700; text-align: right;">{{ invoice.due_date.strftime('%d/%m/%Y') }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Información compacta - Cliente e Información de Pago (REDUCIDO A LA MITAD) -->
    <div style="padding: 0.1in; border-bottom: 1px solid #d1d5db;" class="page-break-avoid">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.1in;">
            <!-- Cliente -->
            <div class="info-section">
                <h2 style="font-size: 8pt; font-weight: 700; color: #374151; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.05in; border-bottom: 1px solid #d1d5db; padding-bottom: 0.03in;">Cliente</h2>
                <div style="background-color: #f9fafb; border: 1px solid #e5e7eb; padding: 0.08in; border-radius: 3px; flex-grow: 1;">
                    <div style="display: flex; flex-direction: column; gap: 0.05in;">
                        <div>
                            <p style="font-size: 9pt; font-weight: 700; color: #111827; margin: 0;">{{ invoice.customer.full_name }}</p>
                            {% if invoice.customer.id_number %}
                            <p style="font-size: 8pt; color: #4b5563; margin-top: 0.03in;">
                                <span style="font-weight: 600;">{{ invoice.customer.id_type|upper }}:</span>
                                {{ invoice.customer.id_number }}
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Información de Pago -->
            <div class="info-section">
                <h2 style="font-size: 8pt; font-weight: 700; color: #374151; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.05in; border-bottom: 1px solid #d1d5db; padding-bottom: 0.03in;">Información de Pago</h2>
                <div style="background-color: #eef2ff; border: 1px solid #c7d2fe; padding: 0.08in; border-radius: 3px; flex-grow: 1;">
                    <div style="display: flex; flex-direction: column; gap: 0.08in;">
                        <div>
                            <p style="font-size: 9pt; font-weight: 700; color: #3730a3;">{{ invoice.payment_method|title }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de items optimizada -->
    <div style="padding: 0.15in;" class="page-break-avoid">
        <h2 style="font-size: 8pt; font-weight: 700; color: #374151; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.05in; border-bottom: 1px solid #d1d5db; padding-bottom: 0.03in;">Detalle de Productos/Servicios</h2>
        <div style="overflow: hidden; border: 1px solid #d1d5db; border-radius: 3px;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background-color: #f3f4f6; border-bottom: 1px solid #d1d5db;">
                        <th style="text-align: left; padding: 0.08in; font-weight: 700; color: #111827; text-transform: uppercase; font-size: 7pt; letter-spacing: 0.05em; width: 10%; text-align: center;">Cant.</th>
                        <th style="text-align: left; padding: 0.08in; font-weight: 700; color: #111827; text-transform: uppercase; font-size: 7pt; letter-spacing: 0.05em; width: 50%;">Descripción</th>
                        <th style="text-align: right; padding: 0.08in; font-weight: 700; color: #111827; text-transform: uppercase; font-size: 7pt; letter-spacing: 0.05em; width: 20%;">P. Unitario</th>
                        <th style="text-align: right; padding: 0.08in; font-weight: 700; color: #111827; text-transform: uppercase; font-size: 7pt; letter-spacing: 0.05em; width: 20%;">Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in invoice.items.order_by('line_order').all() %}
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                        <td style="padding: 0.08in; color: #111827; font-weight: 700; text-align: center; vertical-align: top; font-size: 8pt;">
                            {{ item.quantity }}
                        </td>
                        <td style="padding: 0.08in; color: #111827; vertical-align: top;">
                            <div style="font-weight: 600; color: #111827; font-size: 8pt; margin-bottom: 0.02in;">{{ item.description }}</div>
                        </td>
                        <td style="padding: 0.08in; text-align: right; color: #111827; vertical-align: top; font-weight: 600; font-size: 8pt;">
                            RD$ {{ "{:,.2f}".format(item.unit_price|float) }}
                        </td>
                        <td style="padding: 0.08in; text-align: right; font-weight: 700; color: #111827; vertical-align: top; font-size: 8pt;">
                            RD$ {{ "{:,.2f}".format(item.line_total|float) }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Totales (ANTES de notas y términos) -->
    <div style="padding: 0.15in; background-color: #f9fafb; border-top: 1px solid #d1d5db;" class="page-break-avoid">
        <div style="background-color: white; border: 1px solid #9ca3af; border-radius: 3px; padding: 0.15in; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
            <div style="display: flex; flex-direction: column; gap: 0.08in;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 0.06in; border-bottom: 1px solid #d1d5db;">
                    <span style="color: #4b5563; font-size: 8pt; font-weight: 600;">Subtotal:</span>
                    <span style="color: #111827; font-size: 9pt; font-weight: 700;" id="subtotal-display">
                        RD$ {{ "{:,.2f}".format(invoice.subtotal|float) }}
                    </span>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 0.06in; border-bottom: 1px solid #d1d5db;">
                    <span style="color: #4b5563; font-size: 8pt; font-weight: 600;">ITBIS (18%):</span>
                    <span style="color: #111827; font-size: 9pt; font-weight: 700;" id="tax-display">
                        RD$ {{ "{:,.2f}".format(invoice.tax_amount|float) }}
                    </span>
                </div>

                <div style="padding-top: 0.08in; border-top: 2px solid #9ca3af;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 9pt; font-weight: 700; color: #111827;">TOTAL FACTURA:</span>
                        <span style="font-size: 11pt; font-weight: 900; color: #3730a3;" id="total-display">
                            RD$ {{ "{:,.2f}".format(invoice.total|float) }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notas y términos (DESPUÉS de totales) -->
    <div style="padding: 0.15in; background-color: #f9fafb; border-top: 1px solid #d1d5db;" class="page-break-avoid">
        <div style="display: flex; flex-direction: column; gap: 0.1in;">
            {% if invoice.notes %}
            <div style="background-color: #fffbeb; border: 1px solid #fbbf24; border-radius: 3px; padding: 0.1in;">
                <h3 style="font-weight: 700; color: #92400e; font-size: 8pt; margin-bottom: 0.03in; text-transform: uppercase;">Notas</h3>
                <div style="font-size: 8pt; color: #111827; white-space: pre-line; line-height: 1.3;">{{ invoice.notes }}</div>
            </div>
            {% endif %}

            {% if invoice.terms %}
            <div style="background-color: #eff6ff; border: 1px solid #60a5fa; border-radius: 3px; padding: 0.1in;">
                <h3 style="font-weight: 700; color: #1e40af; font-size: 8pt; margin-bottom: 0.03in; text-transform: uppercase;">Términos y Condiciones</h3>
                <div style="font-size: 8pt; color: #111827; white-space: pre-line; line-height: 1.3;">{{ invoice.terms }}</div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Pie de página optimizado -->
    <div style="padding: 0.1in; border-top: 1px solid #d1d5db; background-color: #f3f4f6; text-align: center; font-size: 7pt;" class="page-break-avoid">
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.1in; color: #4b5563; margin-bottom: 0.05in;">
            <div style="text-align: left;">
                <p style="font-weight: 600; margin-bottom: 0.02in;">Emitido por:</p>
                <p style="margin: 0;">{{ settings.company_name }}</p>
                {% if settings.company_rnc %}
                <p style="margin: 0;">RNC: {{ settings.company_rnc }}</p>
                {% endif %}
            </div>
            <div style="text-align: center;">
                <p style="font-weight: 600; margin-bottom: 0.02in;">Documento válido</p>
                <p style="margin: 0;">Factura {{ invoice.invoice_number }}</p>
                <p style="margin: 0;">Fecha: {{ invoice.invoice_date.strftime('%d/%m/%Y') }}</p>
            </div>
            <div style="text-align: right;">
                <p style="font-weight: 600; margin-bottom: 0.02in;">Condiciones</p>
                <p style="margin: 0;">{% if invoice.due_date %}Vence: {{ invoice.due_date.strftime('%d/%m/%Y') }}{% else %}Pago inmediato{% endif %}</p>
                <p style="margin: 0;">Método: {{ invoice.payment_method|title }}</p>
            </div>
        </div>
        <div style="padding-top: 0.05in; border-top: 1px solid #d1d5db; color: #6b7280; font-size: 6pt;">
            <p style="margin: 0.02in 0;">Este documento es una representación impresa de la factura electrónica original</p>
            <p style="margin: 0.02in 0;">NCF: {{ invoice.ncf }} | Fecha de emisión: {{ invoice.invoice_date.strftime('%d/%m/%Y') }}</p>
        </div>
    </div>
</div>

<!-- Botón de eliminación (no se muestra en impresión) -->
{% if invoice.status == 'draft' %}
<div class="max-w-4xl mx-auto mt-6 flex justify-center delete-section no-print" id="boton-eliminar">
    <!-- ... formulario de eliminación ... -->
</div>
{% endif %}

<script>
    // Función optimizada para impresión perfecta
    function imprimirFacturaPerfeta() {
        console.log('Preparando impresión perfecta...');

        // Configurar para impresión
        document.querySelectorAll('*').forEach(el => {
            el.style.webkitPrintColorAdjust = 'exact';
            el.style.printColorAdjust = 'exact';
            el.style.colorAdjust = 'exact';
        });

        // Pequeño delay para asegurar que todo esté listo
        setTimeout(() => {
            window.print();
        }, 100);
    }

    // Añadir mensajes antes y después de imprimir
    window.addEventListener('beforeprint', function() {
        console.log('Iniciando impresión perfecta...');
        document.body.style.width = '8.5in';
        document.body.style.height = '11in';
        document.body.style.margin = '0';
        document.body.style.padding = '0';
    });

    window.addEventListener('afterprint', function() {
        console.log('Impresión completada perfectamente');
        document.body.style = '';
    });

    // Configurar fechas automáticas
    document.addEventListener('DOMContentLoaded', function() {
        const printButton = document.querySelector('button[onclick="imprimirFacturaPerfeta()"]');
        if (printButton) {
            printButton.addEventListener('click', imprimirFacturaPerfeta);
        }

        console.log('Factura optimizada para impresión perfecta en papel carta');
    });
</script>
{% endblock %}